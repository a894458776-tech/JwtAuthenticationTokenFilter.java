<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kylin.kton.system.mapper.KtonOrderMapper">

    <resultMap type="KtonOrder" id="KtonOrderResult">
        <result property="id"    column="id"    />
        <result property="merchantId"    column="merchant_id"    />
        <result property="orderNo"    column="order_no"    />
        <result property="domain"    column="domain"    />
        <result property="productName"    column="product_name"    />
        <result property="productType"    column="product_type"    />
        <result property="quantity"    column="quantity"    />
        <result property="totalAmount"    column="total_amount"    />
        <result property="currency"    column="currency"    />
        <result property="status"    column="status"    />
        <result property="paidStatus"    column="paid_status"    />
        <result property="payMethod"    column="pay_method"    />
        <result property="payMode"    column="pay_mode"    />
        <result property="totalIps"    column="total_ips"    />
        <result property="udp"    column="udp"    />
        <result property="staticCountryNums"    column="static_country_nums"    />
        <result property="effectiveDatetime"    column="effective_datetime"    />
        <result property="expireDatetime"    column="expire_datetime"    />
        <result property="nextNotifyTime"    column="next_notify_time"    />
        <result property="notifyCount"    column="notify_count"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectKtonOrderVo">
        select id, merchant_id, order_no, domain, product_name, product_type, quantity, total_amount, currency, status, paid_status, pay_method, pay_mode, total_ips, udp, static_country_nums, effective_datetime, expire_datetime, next_notify_time, notify_count, create_time, update_time from kton_order
    </sql>

    <select id="selectKtonOrderList" parameterType="KtonOrder" resultMap="KtonOrderResult">
        <include refid="selectKtonOrderVo"/>
        <where>
            <if test="merchantId != null "> and merchant_id = #{merchantId}</if>
            <if test="orderNo != null  and orderNo != ''"> and order_no = #{orderNo}</if>
            <if test="domain != null  and domain != ''"> and domain = #{domain}</if>
            <if test="productName != null  and productName != ''"> and product_name like concat('%', #{productName}, '%')</if>
            <if test="productType != null "> and product_type = #{productType}</if>
            <if test="quantity != null "> and quantity = #{quantity}</if>
            <if test="totalAmount != null "> and total_amount = #{totalAmount}</if>
            <if test="currency != null  and currency != ''"> and currency = #{currency}</if>
            <if test="status != null "> and status = #{status}</if>
            <if test="paidStatus != null "> and paid_status = #{paidStatus}</if>
            <if test="payMethod != null  and payMethod != ''"> and pay_method = #{payMethod}</if>
            <if test="payMode != null  and payMode != ''"> and pay_mode = #{payMode}</if>
            <if test="totalIps != null "> and total_ips = #{totalIps}</if>
            <if test="udp != null  and udp != ''"> and udp = #{udp}</if>
            <if test="staticCountryNums != null  and staticCountryNums != ''"> and static_country_nums = #{staticCountryNums}</if>
            <if test="effectiveDatetime != null "> and effective_datetime = #{effectiveDatetime}</if>
            <if test="expireDatetime != null "> and expire_datetime = #{expireDatetime}</if>
            <if test="nextNotifyTime != null "> and next_notify_time = #{nextNotifyTime}</if>
            <if test="notifyCount != null "> and notify_count = #{notifyCount}</if>
        </where>
    </select>

    <select id="selectKtonOrderById" parameterType="Long" resultMap="KtonOrderResult">
        <include refid="selectKtonOrderVo"/>
        where id = #{id}
    </select>

    <insert id="insertKtonOrder" parameterType="KtonOrder" useGeneratedKeys="true" keyProperty="id">
        insert into kton_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="merchantId != null">merchant_id,</if>
            <if test="orderNo != null and orderNo != ''">order_no,</if>
            <if test="domain != null">domain,</if>
            <if test="productName != null and productName != ''">product_name,</if>
            <if test="productType != null">product_type,</if>
            <if test="quantity != null">quantity,</if>
            <if test="totalAmount != null">total_amount,</if>
            <if test="currency != null and currency != ''">currency,</if>
            <if test="status != null">status,</if>
            <if test="paidStatus != null">paid_status,</if>
            <if test="payMethod != null">pay_method,</if>
            <if test="payMode != null">pay_mode,</if>
            <if test="totalIps != null">total_ips,</if>
            <if test="udp != null">udp,</if>
            <if test="staticCountryNums != null">static_country_nums,</if>
            <if test="effectiveDatetime != null">effective_datetime,</if>
            <if test="expireDatetime != null">expire_datetime,</if>
            <if test="nextNotifyTime != null">next_notify_time,</if>
            <if test="notifyCount != null">notify_count,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="merchantId != null">#{merchantId},</if>
            <if test="orderNo != null and orderNo != ''">#{orderNo},</if>
            <if test="domain != null">#{domain},</if>
            <if test="productName != null and productName != ''">#{productName},</if>
            <if test="productType != null">#{productType},</if>
            <if test="quantity != null">#{quantity},</if>
            <if test="totalAmount != null">#{totalAmount},</if>
            <if test="currency != null and currency != ''">#{currency},</if>
            <if test="status != null">#{status},</if>
            <if test="paidStatus != null">#{paidStatus},</if>
            <if test="payMethod != null">#{payMethod},</if>
            <if test="payMode != null">#{payMode},</if>
            <if test="totalIps != null">#{totalIps},</if>
            <if test="udp != null">#{udp},</if>
            <if test="staticCountryNums != null">#{staticCountryNums},</if>
            <if test="effectiveDatetime != null">#{effectiveDatetime},</if>
            <if test="expireDatetime != null">#{expireDatetime},</if>
            <if test="nextNotifyTime != null">#{nextNotifyTime},</if>
            <if test="notifyCount != null">#{notifyCount},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updateKtonOrder" parameterType="KtonOrder">
        update kton_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="merchantId != null">merchant_id = #{merchantId},</if>
            <if test="orderNo != null and orderNo != ''">order_no = #{orderNo},</if>
            <if test="domain != null">domain = #{domain},</if>
            <if test="productName != null and productName != ''">product_name = #{productName},</if>
            <if test="productType != null">product_type = #{productType},</if>
            <if test="quantity != null">quantity = #{quantity},</if>
            <if test="totalAmount != null">total_amount = #{totalAmount},</if>
            <if test="currency != null and currency != ''">currency = #{currency},</if>
            <if test="status != null">status = #{status},</if>
            <if test="paidStatus != null">paid_status = #{paidStatus},</if>
            <if test="payMethod != null">pay_method = #{payMethod},</if>
            <if test="payMode != null">pay_mode = #{payMode},</if>
            <if test="totalIps != null">total_ips = #{totalIps},</if>
            <if test="udp != null">udp = #{udp},</if>
            <if test="staticCountryNums != null">static_country_nums = #{staticCountryNums},</if>
            <if test="effectiveDatetime != null">effective_datetime = #{effectiveDatetime},</if>
            <if test="expireDatetime != null">expire_datetime = #{expireDatetime},</if>
            <if test="nextNotifyTime != null">next_notify_time = #{nextNotifyTime},</if>
            <if test="notifyCount != null">notify_count = #{notifyCount},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteKtonOrderById" parameterType="Long">
        delete from kton_order where id = #{id}
    </delete>

    <delete id="deleteKtonOrderByIds" parameterType="String">
        delete from kton_order where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <resultMap type="com.kylin.kton.client.order.entity.dto.ClientOrderDetailDTO"
               id="ClientOrderResult"
               extends="KtonOrderResult">
        <result property="staticIp" column="staticIp"/>
    </resultMap>

    <select id="orderList" resultMap="ClientOrderResult">
        SELECT
        o.id,
        o.merchant_id,
        o.order_no,
        o.domain,
        o.product_name,
        o.product_type,
        o.quantity,
        o.total_amount,
        o.currency,
        o.status,
        o.paid_status,
        o.pay_method,
        o.pay_mode,
        o.total_ips,
        o.udp,
        o.static_country_nums,
        o.effective_datetime,
        o.expire_datetime,
        o.create_time,
        o.update_time,

        -- 【核心修改】使用子查询获取 IP
        -- 这样不需要在主查询加 GROUP BY，分页更稳定，也不会漏数据
        (SELECT GROUP_CONCAT(s.ip SEPARATOR ', ')
        FROM kton_order_item_static s
        WHERE s.order_id = o.id) AS staticIp

        FROM kton_order o
        <where>
            <if test="merchantId != null "> and o.merchant_id = #{merchantId}</if>
            <if test="orderNo != null  and orderNo != ''"> and o.order_no = #{orderNo}</if>
            <if test="productName != null  and productName != ''"> and o.product_name like concat('%', #{productName}, '%')</if>
            <if test="productType != null "> and o.product_type = #{productType}</if>
            <if test="status != null "> and o.status = #{status}</if>
            <if test="paidStatus != null "> and o.paid_status = #{paidStatus}</if>
            <if test="payMethod != null  and payMethod != ''"> and o.pay_method = #{payMethod}</if>
            <if test="payMode != null  and payMode != ''"> and o.pay_mode = #{payMode}</if>
            <if test="totalIps != null "> and o.total_ips = #{totalIps}</if>
            <if test="staticCountryNums != null  and staticCountryNums != ''"> and o.static_country_nums = #{staticCountryNums}</if>
        </where>
        ORDER BY o.create_time DESC
    </select>

</mapper>